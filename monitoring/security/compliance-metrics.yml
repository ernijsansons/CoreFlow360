# CoreFlow360 Compliance Monitoring Metrics
# SOC2, ISO27001, GDPR, HIPAA, and other compliance frameworks

groups:
- name: compliance.soc2
  interval: 300s
  rules:
  
  # SOC2 Type II Controls
  - record: soc2_access_control_score
    expr: |
      (
        (count(kube_pod_spec_containers{security_context_run_as_user!="0"}) / count(kube_pod_spec_containers)) * 0.25 +
        (count(rbac_subject_permissions{permission="restricted"}) / count(rbac_subject_permissions)) * 0.25 +
        (count(network_policy_rules{rule_type="deny"}) / count(network_policy_rules)) * 0.25 +
        (count(secret_encrypted_at_rest) / count(secret_total)) * 0.25
      ) * 100
      
  - record: soc2_availability_score
    expr: |
      (
        (avg_over_time(up{job="consciousness"}[24h])) * 0.4 +
        (1 - rate(kubernetes_pod_restart_total[24h]) / 10) * 0.3 +
        (avg_over_time(probe_success{job="blackbox"}[24h])) * 0.3
      ) * 100
      
  - record: soc2_confidentiality_score
    expr: |
      (
        (count(secret_rotated_recently) / count(secret_total)) * 0.3 +
        (count(encrypted_communication_enabled) / count(service_communication_total)) * 0.3 +
        (count(data_classification_applied) / count(data_stores_total)) * 0.4
      ) * 100
      
  - record: soc2_processing_integrity_score
    expr: |
      (
        (count(input_validation_enabled) / count(api_endpoints_total)) * 0.3 +
        (count(audit_log_integrity_verified) / count(audit_log_files_total)) * 0.4 +
        (count(code_signed_deployments) / count(deployments_total)) * 0.3
      ) * 100
      
  - record: soc2_privacy_score
    expr: |
      (
        (count(pii_data_encrypted) / count(pii_data_stores)) * 0.4 +
        (count(consent_management_enabled) / count(user_data_processing)) * 0.3 +
        (count(data_retention_policy_applied) / count(data_stores_total)) * 0.3
      ) * 100

- name: compliance.iso27001
  interval: 300s
  rules:
  
  # ISO 27001 Information Security Controls
  - record: iso27001_information_security_policies_score
    expr: |
      (
        (count(security_policy_documented) / count(security_policies_required)) * 0.5 +
        (count(security_policy_communicated) / count(employees_total)) * 0.3 +
        (count(security_policy_reviewed_annually) / count(security_policies_total)) * 0.2
      ) * 100
      
  - record: iso27001_access_control_score
    expr: |
      (
        (count(user_access_review_completed) / count(user_accounts_total)) * 0.3 +
        (count(privileged_access_monitored) / count(privileged_accounts_total)) * 0.4 +
        (count(access_termination_automated) / count(employee_departures_total)) * 0.3
      ) * 100
      
  - record: iso27001_cryptography_score
    expr: |
      (
        (count(data_encrypted_in_transit) / count(data_flows_total)) * 0.4 +
        (count(data_encrypted_at_rest) / count(data_stores_total)) * 0.4 +
        (count(key_management_policy_applied) / count(encryption_keys_total)) * 0.2
      ) * 100
      
  - record: iso27001_incident_management_score
    expr: |
      (
        (count(incident_response_plan_tested) / count(incident_response_plans)) * 0.3 +
        (count(incidents_reported_timely) / count(security_incidents_total)) * 0.4 +
        (count(incident_lessons_learned_documented) / count(resolved_incidents_total)) * 0.3
      ) * 100

- name: compliance.gdpr
  interval: 300s
  rules:
  
  # GDPR Compliance Metrics
  - record: gdpr_data_protection_by_design_score
    expr: |
      (
        (count(privacy_impact_assessment_completed) / count(new_data_processing_activities)) * 0.4 +
        (count(data_minimization_principle_applied) / count(data_collection_processes)) * 0.3 +
        (count(purpose_limitation_enforced) / count(data_processing_activities)) * 0.3
      ) * 100
      
  - record: gdpr_consent_management_score
    expr: |
      (
        (count(explicit_consent_obtained) / count(data_processing_requiring_consent)) * 0.4 +
        (count(consent_withdrawal_mechanism_available) / count(consent_dependent_processes)) * 0.3 +
        (count(consent_records_maintained) / count(consent_given_total)) * 0.3
      ) * 100
      
  - record: gdpr_data_subject_rights_score
    expr: |
      (
        (count(data_portability_requests_fulfilled) / count(data_portability_requests_total)) * 0.2 +
        (count(erasure_requests_fulfilled) / count(erasure_requests_total)) * 0.3 +
        (count(access_requests_fulfilled_timely) / count(access_requests_total)) * 0.3 +
        (count(rectification_requests_fulfilled) / count(rectification_requests_total)) * 0.2
      ) * 100
      
  - record: gdpr_data_breach_response_score
    expr: |
      (
        (count(breaches_reported_to_authority_72h) / count(reportable_breaches_total)) * 0.5 +
        (count(data_subjects_notified_timely) / count(breaches_affecting_data_subjects)) * 0.3 +
        (count(breach_documentation_complete) / count(data_breaches_total)) * 0.2
      ) * 100

- name: compliance.hipaa
  interval: 300s
  rules:
  
  # HIPAA Compliance Metrics (if applicable)
  - record: hipaa_administrative_safeguards_score
    expr: |
      (
        (count(security_officer_designated) / 1) * 0.2 +
        (count(workforce_training_completed) / count(employees_with_phi_access)) * 0.3 +
        (count(access_authorization_procedures_followed) / count(phi_access_requests)) * 0.3 +
        (count(contingency_plan_tested) / count(required_contingency_tests)) * 0.2
      ) * 100
      
  - record: hipaa_physical_safeguards_score
    expr: |
      (
        (count(facility_access_controls_implemented) / count(facilities_with_phi)) * 0.4 +
        (count(workstation_access_controls_implemented) / count(workstations_with_phi_access)) * 0.3 +
        (count(media_controls_implemented) / count(media_containing_phi)) * 0.3
      ) * 100
      
  - record: hipaa_technical_safeguards_score
    expr: |
      (
        (count(unique_user_identification_implemented) / count(users_with_phi_access)) * 0.2 +
        (count(automatic_logoff_implemented) / count(phi_access_systems)) * 0.2 +
        (count(encryption_implemented) / count(phi_transmissions)) * 0.3 +
        (count(audit_controls_implemented) / count(phi_systems)) * 0.3
      ) * 100

- name: compliance.pci_dss
  interval: 300s
  rules:
  
  # PCI DSS Compliance Metrics (if processing payment data)
  - record: pci_dss_network_security_score
    expr: |
      (
        (count(firewall_rules_documented) / count(firewall_rules_total)) * 0.3 +
        (count(default_passwords_changed) / count(network_devices_total)) * 0.3 +
        (count(network_segmentation_implemented) / count(required_network_segments)) * 0.4
      ) * 100
      
  - record: pci_dss_data_protection_score
    expr: |
      (
        (count(cardholder_data_encrypted) / count(cardholder_data_stores)) * 0.4 +
        (count(cardholder_data_masked) / count(cardholder_data_displays)) * 0.3 +
        (count(encryption_keys_managed_securely) / count(encryption_keys_total)) * 0.3
      ) * 100
      
  - record: pci_dss_vulnerability_management_score
    expr: |
      (
        (count(antivirus_updated_regularly) / count(systems_requiring_antivirus)) * 0.3 +
        (count(security_patches_applied_timely) / count(security_patches_required)) * 0.4 +
        (count(vulnerability_scans_passed) / count(vulnerability_scans_required)) * 0.3
      ) * 100

- name: compliance.overall
  interval: 300s
  rules:
  
  # Overall Compliance Score
  - record: compliance_overall_score
    expr: |
      (
        (soc2_access_control_score + soc2_availability_score + soc2_confidentiality_score + soc2_processing_integrity_score + soc2_privacy_score) / 5 * 0.3 +
        (iso27001_information_security_policies_score + iso27001_access_control_score + iso27001_cryptography_score + iso27001_incident_management_score) / 4 * 0.3 +
        (gdpr_data_protection_by_design_score + gdpr_consent_management_score + gdpr_data_subject_rights_score + gdpr_data_breach_response_score) / 4 * 0.2 +
        (hipaa_administrative_safeguards_score + hipaa_physical_safeguards_score + hipaa_technical_safeguards_score) / 3 * 0.1 +
        (pci_dss_network_security_score + pci_dss_data_protection_score + pci_dss_vulnerability_management_score) / 3 * 0.1
      )
      
  # Compliance Status Indicators
  - record: compliance_status_soc2
    expr: |
      (soc2_access_control_score + soc2_availability_score + soc2_confidentiality_score + soc2_processing_integrity_score + soc2_privacy_score) / 5 >= 85
      
  - record: compliance_status_iso27001
    expr: |
      (iso27001_information_security_policies_score + iso27001_access_control_score + iso27001_cryptography_score + iso27001_incident_management_score) / 4 >= 80
      
  - record: compliance_status_gdpr
    expr: |
      (gdpr_data_protection_by_design_score + gdpr_consent_management_score + gdpr_data_subject_rights_score + gdpr_data_breach_response_score) / 4 >= 90
      
  # Compliance Alerts
  - alert: ComplianceThresholdBreach
    expr: compliance_overall_score < 80
    for: 15m
    labels:
      severity: warning
      category: compliance
    annotations:
      summary: "Overall compliance score below threshold"
      description: "Compliance score is {{ $value }}%, below the required 80%"
      
  - alert: SOC2ComplianceRisk
    expr: (soc2_access_control_score + soc2_availability_score + soc2_confidentiality_score + soc2_processing_integrity_score + soc2_privacy_score) / 5 < 85
    for: 10m
    labels:
      severity: warning
      category: soc2_compliance
    annotations:
      summary: "SOC2 compliance score below threshold"
      description: "SOC2 score is {{ $value }}%, below the required 85%"
      
  - alert: GDPRComplianceRisk
    expr: (gdpr_data_protection_by_design_score + gdpr_consent_management_score + gdpr_data_subject_rights_score + gdpr_data_breach_response_score) / 4 < 90
    for: 10m
    labels:
      severity: critical
      category: gdpr_compliance
    annotations:
      summary: "GDPR compliance score below threshold"
      description: "GDPR score is {{ $value }}%, below the required 90%"